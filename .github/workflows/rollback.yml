name: Rollback - Render Deploy

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CD - Deploy to Render"]
    types:
      - completed

jobs:
  rollback:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Instalar jq
        run: sudo apt-get install -y jq

      - name: üîë Set variables
        run: |
          echo "RENDER_SERVICE_ID=srv-d4co8ak9c44c738ugpbg" >> $GITHUB_ENV

      - name: üì• Obtener lista de deploys desde Render
        run: |
          curl -s -X GET "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Accept: application/json" > deploys.json
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

      - name: üîç Identificar √∫ltimo deploy exitoso
        run: |
          LAST_SUCCESS=$(jq -r '.[] | select(.status=="live") | .id' deploys.json | head -n 1)
          echo "√öltimo deploy exitoso: $LAST_SUCCESS"
          echo "LAST_SUCCESS=$LAST_SUCCESS" >> $GITHUB_ENV

      - name: ‚ôªÔ∏è Ejecutar rollback
        run: |
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$LAST_SUCCESS/rollback" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Accept: application/json"
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
