name: CD - Deploy to Render

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: üî¢ Generar versi√≥n de despliegue
        run: |
          VERSION="${GITHUB_RUN_NUMBER}-${GITHUB_SHA:0:7}"
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV

      - name: üìù Insertar versi√≥n en application.yml
        run: |
          sed -i "s/app.version:.*/app.version: ${APP_VERSION}/" src/main/resources/application.yml
          echo "Nueva version aplicada: ${APP_VERSION}"

      - name: üöÄ Trigger Render Deploy Hook con manejo de error
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$RENDER_DEPLOY_HOOK")
          echo "Render returned HTTP $STATUS"
          if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
            echo "‚ùå Render deploy failed"
            exit 1
          fi
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}

  rollback:
    needs: deploy
    if: ${{ failure() }}  # Ejecuta rollback si el deploy fall√≥
    runs-on: ubuntu-latest

    steps:
      - name: Trigger rollback workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "Rollback - Render Deploy"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
